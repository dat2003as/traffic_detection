<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Traffic Monitor</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #10b981;
            --dark-bg: #0f172a;
            --card-bg: #ffffff;
            --text-color: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--text-color);
            padding-bottom: 50px;
        }

        /* Navbar */
        .navbar {
            background: var(--dark-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Cards */
        .custom-card {
            background: var(--card-bg);
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
            height: 100%;
            overflow: hidden;
        }
        .custom-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .card-header-custom {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
            position: relative;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary-color);
            background: #eef2ff;
        }
        .upload-zone i {
            font-size: 2rem;
            color: #94a3b8;
            margin-bottom: 10px;
        }
        .hidden-input {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Preview Areas */
        .preview-box {
            background: #000;
            border-radius: 12px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-top: 20px;
            position: relative;
        }
        .preview-box img, .preview-box video {
            width: 100%;
            height: auto;
            max-height: 450px;
            object-fit: contain;
        }
        .placeholder-text {
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Terminal Log */
        .console-log {
            background: #1e293b;
            color: #4ade80;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            padding: 15px;
            border-radius: 8px;
            height: 150px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #334155;
        }
        .console-log::-webkit-scrollbar { width: 6px; }
        .console-log::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Buttons */
        .btn-custom-primary {
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            border: none;
            width: 100%;
            transition: 0.2s;
        }
        .btn-custom-primary:hover { background-color: #4338ca; }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
            border-radius: 12px;
            display: none;
        }

        /* Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-dark mb-5">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <i class="fa-solid fa-video me-2 text-warning"></i>
            AI Traffic Vision
        </a>
        <div class="text-white small opacity-75">System v2.1</div>
    </div>
</nav>

<div class="container">
    
    <div class="row g-4">
        <!-- C·ªòT TR√ÅI: IMAGE DETECTION -->
        <div class="col-lg-6">
            <div class="custom-card">
                <div class="card-header-custom text-primary">
                    <i class="fa-solid fa-camera"></i> Ph√¢n t√≠ch H√¨nh ·∫£nh
                </div>
                <div class="card-body p-4">
                    <!-- Upload Zone -->
                    <div class="upload-zone" id="imgDropZone">
                        <input type="file" class="hidden-input" id="imgInput" accept="image/*" onchange="handleImgSelect(this)">
                        <i class="fa-regular fa-image"></i>
                        <p class="mb-0 fw-bold" id="imgLabel">K√©o th·∫£ ho·∫∑c Click ƒë·ªÉ ch·ªçn ·∫£nh</p>
                        <small class="text-muted">H·ªó tr·ª£: JPG, PNG, JPEG</small>
                    </div>

                    <button class="btn-custom-primary mt-3" onclick="detectImage()">
                        <i class="fa-solid fa-bolt me-2"></i> Ch·∫°y Detect
                    </button>

                    <!-- Result Area -->
                    <div class="preview-box" id="imgPreviewBox">
                        <div class="loading-overlay" id="imgLoading">
                            <div class="spinner-border text-primary mb-2" role="status"></div>
                            <span>ƒêang ph√¢n t√≠ch...</span>
                        </div>
                        <span class="placeholder-text text-white-50" id="imgPlaceholder">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</span>
                        <img id="imgResult" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <!-- C·ªòT PH·∫¢I: VIDEO PROCESSING -->
        <div class="col-lg-6">
            <div class="custom-card">
                <div class="card-header-custom text-success">
                    <i class="fa-solid fa-film"></i> X·ª≠ l√Ω Video (H.264)
                </div>
                <div class="card-body p-4">
                    <!-- Upload Zone -->
                    <div class="upload-zone" id="vidDropZone">
                        <input type="file" class="hidden-input" id="vidInput" accept="video/*" onchange="handleVidSelect(this)">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                        <p class="mb-0 fw-bold" id="vidLabel">K√©o th·∫£ ho·∫∑c Click ƒë·ªÉ ch·ªçn video</p>
                        <small class="text-muted">H·ªó tr·ª£: MP4 (T·ª± ƒë·ªông convert lu·ªìng)</small>
                    </div>

                    <button class="btn-custom-primary mt-3 bg-success" onclick="processVideo()">
                        <i class="fa-solid fa-play me-2"></i> Upload & X·ª≠ l√Ω
                    </button>

                    <!-- Console Log -->
                    <div id="videoLogs" class="console-log">
                        <div><span class="opacity-50">root@ai-system:~$</span> S·∫µn s√†ng x·ª≠ l√Ω...</div>
                    </div>

                    <!-- Result Area -->
                    <div class="preview-box" id="vidPreviewBox" style="display:none; min-height: auto; background: transparent;">
                        <div class="bg-dark rounded-3 overflow-hidden w-100 shadow">
                            <video id="vidResult" controls class="w-100 d-block"></video>
                            <div class="p-3 bg-dark border-top border-secondary d-flex justify-content-between align-items-center">
                                <div class="text-white-50 small">
                                    <i class="fa-solid fa-fingerprint me-1"></i> 
                                    ID: <span id="vidTaskIdText">...</span>
                                </div>
                                <a id="vidDownload" href="#" class="btn btn-sm btn-light fw-bold" target="_blank">
                                    <i class="fa-solid fa-download me-1"></i> T·∫£i v·ªÅ
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION: TRA C·ª®U L·ªäCH S·ª¨ -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="custom-card border-top border-4 border-info">
                <div class="card-header-custom">
                    <i class="fa-solid fa-clock-rotate-left text-info"></i> Tra c·ª©u L·ªãch s·ª≠ (Theo ID)
                </div>
                <div class="card-body p-4">
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-6">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                                <input type="number" id="searchId" class="form-control border-start-0 ps-0" placeholder="Nh·∫≠p ID k·∫øt qu·∫£ (VD: 24)">
                                <button class="btn btn-info text-white px-4" onclick="lookupResult()">T√¨m ki·∫øm</button>
                            </div>
                        </div>
                    </div>

                    <!-- K·∫øt qu·∫£ tra c·ª©u -->
                    <div id="lookupResult" style="display:none;" class="row g-4 animate__animated animate__fadeIn">
                        <div class="col-md-7">
                            <div class="rounded-3 overflow-hidden border shadow-sm">
                                <img id="lookupImg" class="img-fluid w-100" src="">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="p-4 bg-white rounded-3 border h-100">
                                <h5 class="fw-bold mb-3 border-bottom pb-2">Chi ti·∫øt vi ph·∫°m</h5>
                                <div id="violationList" class="vstack gap-2" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Item l·ªói -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mt-5 text-muted small">
        &copy; 2025 AI Traffic Vision System. All rights reserved.
    </div>
</div>

<!-- Javascript -->
<script>
    // --- C·∫§U H√åNH ---
    const BASE_URL = "http://127.0.0.1:8000"; // ƒê·ªïi n·∫øu c·∫ßn

    // Helper: Format URL
    function formatPath(path) {
        if (!path) return "";
        let p = path.replace(/\\/g, "/");
        if (!p.startsWith("/")) p = "/" + p;
        return BASE_URL + p;
    }

    // UI Helper: Drag & Drop Effect
    function setupDragDrop(zoneId, inputId, labelId) {
        const zone = document.getElementById(zoneId);
        const input = document.getElementById(inputId);
        const label = document.getElementById(labelId);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        ['dragenter', 'dragover'].forEach(eventName => {
            zone.addEventListener(eventName, () => zone.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, () => zone.classList.remove('dragover'), false);
        });
        zone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            input.files = dt.files;
            handleFiles(input.files, labelId);
        });
    }

    function handleImgSelect(input) { handleFiles(input.files, 'imgLabel'); }
    function handleVidSelect(input) { handleFiles(input.files, 'vidLabel'); }

    function handleFiles(files, labelId) {
        if (files.length > 0) {
            document.getElementById(labelId).innerText = `ƒê√£ ch·ªçn: ${files[0].name}`;
            document.getElementById(labelId).classList.add('text-primary');
        }
    }

    // Init Drag Drop
    setupDragDrop('imgDropZone', 'imgInput', 'imgLabel');
    setupDragDrop('vidDropZone', 'vidInput', 'vidLabel');


    // --- 1. DETECT IMAGE ---
    async function detectImage() {
        const input = document.getElementById('imgInput');
        const imgTag = document.getElementById('imgResult');
        const loading = document.getElementById('imgLoading');
        const placeholder = document.getElementById('imgPlaceholder');

        if(!input.files[0]) return alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc!");

        // UI Reset
        imgTag.style.display = 'none';
        placeholder.style.display = 'none';
        loading.style.display = 'flex';

        const form = new FormData();
        form.append('file', input.files[0]);

        try {
            const res = await fetch(`${BASE_URL}/api/v1/detection/image`, {method: 'POST', body: form});
            if(!res.ok) throw new Error("L·ªói k·∫øt n·ªëi Server");
            const data = await res.json();

            if(data.annotated_image_url) {
                imgTag.src = formatPath(data.annotated_image_url);
                imgTag.onload = () => {
                    loading.style.display = 'none';
                    imgTag.style.display = 'block';
                }
            } else {
                throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ·∫£nh tr·∫£ v·ªÅ");
            }
        } catch(e) {
            alert("L·ªói: " + e.message);
            loading.style.display = 'none';
            placeholder.style.display = 'block';
        }
    }

    // --- 2. PROCESS VIDEO ---
    async function processVideo() {
        const input = document.getElementById('vidInput');
        const logBox = document.getElementById('videoLogs');
        const previewBox = document.getElementById('vidPreviewBox');
        
        if(!input.files[0]) return alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn video tr∆∞·ªõc!");

        // Reset UI
        previewBox.style.display = 'none';
        logBox.innerHTML = `<div><span class="opacity-50">system:~$</span> B·∫Øt ƒë·∫ßu upload...</div>`;

        const log = (msg, color='text-success') => { 
            logBox.innerHTML += `<div class="${color}"><span class="opacity-50">>></span> ${msg}</div>`; 
            logBox.scrollTop = logBox.scrollHeight; 
        }

        try {
            // Step 1: Upload
            const form = new FormData();
            form.append('file', input.files[0]);
            const upRes = await fetch(`${BASE_URL}/api/v1/video/upload`, {method: 'POST', body: form});
            if(!upRes.ok) throw new Error("Upload th·∫•t b·∫°i");
            const upData = await upRes.json();
            const vidId = upData.video_id;
            log(`Upload th√†nh c√¥ng. ID: ${vidId.substring(0,8)}...`);

            // Step 2: Process Stream
            log("ƒêang ph√¢n t√≠ch AI (Stream)...", "text-warning");
            const streamRes = await fetch(`${BASE_URL}/api/v1/video/process-stream?video_id=${vidId}`, {method: 'POST'});
            
            const reader = streamRes.body.getReader();
            const decoder = new TextDecoder();
            let taskId = null;

            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const text = decoder.decode(value);
                
                if(text.includes('"task_id"')) {
                    const lines = text.split('\n');
                    for(let line of lines) {
                        if(line.includes('"event": "complete"')) {
                            try {
                                const j = JSON.parse(line.replace(/^data:\s*/, '').trim());
                                taskId = j.task_id;
                            } catch(e){}
                        }
                    }
                }
            }

            if(!taskId) throw new Error("Kh√¥ng t√¨m th·∫•y Task ID");
            log(`‚úÖ Ho√†n t·∫•t x·ª≠ l√Ω! Task ID: ${taskId}`);
            log(`ƒêang l·∫•y link video...`);

            // Step 3: Get Result
            await fetchVideoResult(taskId, log);

        } catch(e) {
            log(`‚ùå L·ªói: ${e.message}`, "text-danger");
        }
    }

    async function fetchVideoResult(taskId, logFunc) {
        try {
            const res = await fetch(`${BASE_URL}/api/v1/video/status/${taskId}`);
            const data = await res.json();

            let finalPath = data.output_path || (data.result && data.result.output_path);
            let dlUrl = data.download_url;

            // Fallback n·∫øu API thi·∫øu path
            if (!finalPath && data.status === 'completed') {
                logFunc("‚ö†Ô∏è Auto-fix: ƒêang t·∫°o ƒë∆∞·ªùng d·∫´n th·ªß c√¥ng...", "text-info");
                finalPath = `/storage/processed/${taskId}_annotated.mp4`;
                dlUrl = `/api/v1/video/${taskId}/download`;
            }

            if (finalPath) {
                const vidPlayer = document.getElementById('vidResult');
                vidPlayer.src = formatPath(finalPath);
                
                document.getElementById('vidDownload').href = BASE_URL + dlUrl;
                document.getElementById('vidTaskIdText').innerText = taskId;

                // HI·ªÇN TH·ªä VIDEO V√Ä ·∫®N TEXT VI PH·∫†M (THEO Y√äU C·∫¶U C·ª¶A B·∫†N)
                document.getElementById('vidPreviewBox').style.display = 'block';
                
                // Scroll xu·ªëng xem k·∫øt qu·∫£
                document.getElementById('vidPreviewBox').scrollIntoView({behavior: 'smooth'});
                
                logFunc("üéâ ƒê√£ hi·ªÉn th·ªã video b√™n d∆∞·ªõi!", "text-info fw-bold");
            } else {
                logFunc("‚ùå Kh√¥ng th·ªÉ load video.", "text-danger");
            }
        } catch(e) {
            logFunc(`L·ªói Status: ${e.message}`, "text-danger");
        }
    }

    // --- 3. LOOKUP ---
    async function lookupResult() {
        const id = document.getElementById('searchId').value;
        const resBox = document.getElementById('lookupResult');
        if(!id) return alert("‚ö†Ô∏è Nh·∫≠p ID c·∫ßn t√¨m!");
        
        resBox.style.display = 'none';

        try {
            const res = await fetch(`${BASE_URL}/api/v1/detection/result/${id}`, {headers: {'accept': 'application/json'}});
            if(!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu");
            const data = await res.json();

            document.getElementById('lookupImg').src = formatPath(data.file_path);
            const list = document.getElementById('violationList');
            list.innerHTML = "";

            if(data.violations && data.violations.length > 0) {
                data.violations.forEach(v => {
                    const percent = (v.confidence * 100).toFixed(0);
                    list.innerHTML += `
                        <div class="alert alert-danger border-0 shadow-sm mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong><i class="fa-solid fa-triangle-exclamation"></i> ${v.type}</strong>
                                <span class="badge bg-danger">${percent}%</span>
                            </div>
                            <div class="small mt-1 text-muted">${v.description}</div>
                        </div>
                    `;
                });
            } else {
                list.innerHTML = `<div class="alert alert-success"><i class="fa-solid fa-check-circle"></i> Kh√¥ng c√≥ vi ph·∫°m.</div>`;
            }

            resBox.style.display = 'flex';
        } catch(e) {
            alert(e.message);
        }
    }
</script>

</body>
</html>